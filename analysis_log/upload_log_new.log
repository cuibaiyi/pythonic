#!/usr/bin/env python
# -*- coding:utf-8 -*-
import os
import sys
import glob
import shutil
import datetime
import schedule
import time 
import logging
from functools import wraps

log_file = '/data/logs/upload_py.log'
logging.basicConfig(level=logging.INFO,
                    format='%(asctime)s %(levelname)s %(message)s',
                    datefmt='%Y%m%d %H:%M:%S',
                    filename=log_file,
                    filemode='ab+')

def logging_(func):
	@wraps(func)
	def wrapper(*args, **kw):
		ret = func(*args, **kw)
		loging.info(func.__name__ + "Successfully")
		return ret
	return wrapper

src = '/data/backup/'
upload_log_dir = '/data/logs/appgallery_china/'
log_path = '/data/logs/save_log/'
cmd_py = 'ansible AppgalleryVisitLog -m shell -a "python /apps/script/copy_log.py"'
cmd = 'ansible AppgalleryVisitLog -m synchronize -a "src={src} dest={log_path} mode=pull"'
cmd_pull_log = cmd.format(src=src, log_path=log_path)
cmd_cos = 'coscmd upload -rs {upload_log_dir} /appgallery_china/'.format(upload_log_dir=upload_log_dir)
cmd_push_hd = 'rsync -az {upload_log_dir} hadoop@52.77.55.25:/data/archlog/homepage/appgallery_china/'.format(upload_log_dir=upload_log_dir)

T_dir = upload_log_dir + datetime.datetime.now().strftime('%Y/%m/')
if not os.path.exists(T_dir):
  os.makedirs(T_dir)

'''Collect remote node logs'''
@logging_
def collection_log():
	cmd1 = os.system(cmd_py)
    cmd2 = os.system(cmd_pull_log)

    return True if 0 in (cmd1, cmd2) else sys.exit(1)

'''log mv upload_dir'''
@logging_
def mv_log():
  loger = glob.iglob(log_path + '*')
  for logs in loger:
    y_time, m_time, d_time = logs.split(".")[-1].split("-")
    time_dir = ''.join(list([upload_log_dir, y_time, '/', m_time, '/', d_time, '/']))
    if not os.path.exists(time_dir):
      os.makedirs(time_dir)
    shutil.copy2(logs, time_dir)

  return True

'''log upload cos and push hadoop'''
@logging_
def upload_cos():
	cmd1 = os.system(cmd_cos)
	cmd2 = os.system(cmd_push_hd)

	return True if 0 in (cmd1, cmd2) else sys.exit(2)

@logging_
def main():
  collection_log()
  mv_log()    
  upload_cos()
  
if __name__ == '__main__':
  schedule.every().day.at("00:00").do(main)
  while 1:
      schedule.run_pending()
      time.sleep(1)
